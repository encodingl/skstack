{% extends 'navi.html' %}
{% block content %}
<head>
    <meta charset="utf-8"/>
    <title>运维导航</title>
    <link href="/try/bootstrap/twitter-bootstrap-v2/docs/assets/css/bootstrap.css" rel="stylesheet" type="text/css" />
	<link href="/static/css/my.css" rel="stylesheet">
</head>
<style>
@media (min-width: 1200px){.container {
    width: 100%;
}
.content-wrapper{
        margin-left: 0px !important;
}
.sidebar-toggle {
  display:none;
}


</style>
<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
    </section>

    <!-- Main content -->
    <section class="content">

<!--body -->
<div class="container">
    <div class="row">
        <div class="col-md-12 text-center">
            <div class="panel panel-primary">
	         <div class="panel-heading">
		          <h3 class="panel-title">运维公告</h3>
	         </div>
	         <div class="panel-body">
                 <ul class="list-group">
		         {% if notice %}{% for i in notice %}
                          <li class="list-group-item">{{i.notice }}</li>{% endfor %}
                  {% endif %}
                 </ul>
	         </div>
    </div>
    </div>
    </div>
    <hr>
    <div class="row">
        <div class="col-md-2">
            <div class="panel panel-success">
	          <div class="panel-heading">
		       <h3 class="panel-title">平台分类</h3>
              </div>
	          <div class="panel-body">
		         <table class="table table-striped table-bordered table-hover table-bordered">
		           <thead>
				      <tr>
                      {% for key,value in d1.items %}
			           <th>{{ key }}</th></tr>
		           </thead>
		           <tbody>
                   {% for v in value %}
                      <tr>
                        <td><a href="{{v.1}}">{{ v.0 }}</a></td>
                      </tr>{% endfor %}
                  {% endfor %}
		           </tbody>
			     </table>
	          </div>
    </div>
    </div>
    <div class="col-md-10">
      <div class="panel panel-info">
	  <div class="panel-heading">
		<h3 class="panel-title">运维职责表</h3>
	  </div>
	  <div class="panel-body">
		 <table class="table table-hover">
		                  <thead>
			              <tr>
			              <th>运维负责人</th>
			              <th>业务线分工</th>
			              <th>运维系统分工</th>
			              <th>第二负责人</th>
			              </tr>
		                  </thead>
		                  <tbody>
                          {% for i in person %}
                          <tr><td>{{ i.name.nickname }}</td>
                               <td>{% for bussine in i.businessline.all %} {{ bussine }} {% endfor %}</td>
                               <td>{{i.jobclass}}</td>
                               <td>{{i.secondaryname.nickname }}</td>
                          </tr>
                          {% endfor %}
		                  </tbody>
			              </table>
	  </div>
    </div>
     </div>
        <div class="col-md-10">
           <div class="panel panel-info">
	<div class="panel-heading">
		<h3 class="panel-title">运维值班信息</h3>
	</div>
	<div class="panel-body">
        <div class="col-md-8" align="center">
             <table class="table table-hover" id="datasform">
                    		  <thead>
                        		<tr>
                           		<th>星期</th>
                           		<th>运维值班人员</th>
					<th>dba值班人员(ps:dba为周值班)</th>
                        		</tr>
                              </thead>
                              <tbody>
							  {% for key,value in yw_list.items %}
                               <tr class="even gradeX">
								   <td><span class="numberClass"></span></td>
			                        <td>{{ key }} {{value.0}}</td>
								    {% endfor%}
								    <td><span class="js-dba"></span></td>
                                </tr>
							  <tr><td>紧急联系人：{% for i in rota %}{% if i.emergency_contact == 0 %}{{i.name.nickname}} {{ i.iphone.iphone }} {% endif %}{% endfor %}<td></tr>
                              </tbody>
                              </table>
        </div>
        <div class="col-md-4" align="center">
            <table class="table table-hover" id="iphoneform">
                    		  <thead>
                        		<tr>
                           		<th>本周</th>
                           		<th>下周</th>
                        		</tr>
                              </thead>
                              <tbody>
							    <td class="nowweek"></td>
								<td class="nextweek"></td>
                                <tr><td>紧急联系人：{% for i in rota %}{% if i.emergency_contact == 0 %}{{i.name.nickname}} {{ i.iphone.iphone }} {% endif %}{% endfor %}<td></tr>
                              </tbody>
                              </table>
        </div>
	</div>
</div>
        </div>
        <div class="col-md-10">
            <div class="panel panel-danger">
	         <div class="panel-heading">
		     <h3 class="panel-title">运维流程</h3>
	        </div>
	    <div class="panel-body">
			<table class="table table-hover">
		 				 <thead>
							<tr>
			  				<th>等级</th>
			  				<th>响应时间</th>
			 				<th>跟进人员</th>
			 				<th>处理问题和升级流程</th>
			  				<th>参与人员</th>
							</tr>
		  				 </thead>
		                 <tbody>
                           {% for i in events %}
                     		 <tr>
                       		 <td>{{ i.level }}</td>
							 <td>{{ i.responsetime }}</td>
                      		 <td>{{i.processingpersonnel}}</td>
                       		 <td>{{ i.event }}</td>
                      		 <td>{{ i.participant }}</td>
                     		 </tr>
                 			 {% endfor %}
		 				 </tbody>
					 </table>

	    </div>
        </div>
        </div>
    </div>
</div>
<!--bodyend-->
    </section>
 </div>
<script>
 $('.collapse').collapse()
weekofyear =  (((new Date())-(new Date("2017-01-02")))/(24*60*60*7*1000)|0) +1;
rota()
function rota(){
       //dba值班安排
       var dbarr={{ dba_spell_list | safe }};
       var keys = Object.keys(dbarr);
       x = weekofyear%keys.length;

        if((x+1)<3){
           //查找表 --> tbody -->tr --> td
           $("#datasform tbody").find('tr').each(function(){
            	$(this).find('.js-dba').text(keys[x]+' '+ (dbarr[keys[x]][0]));
           });
           }
        else{
                $("#datasform tbody").find('tr').each(function(){
                $(this).find('.js-dba').text(keys[2]+' '+ (dbarr[keys[2]][0]));
           });

        }
         //运维轮流值班安排
          var ywarr={{ yw_spell_list | safe }}
          var ywkeys=Object.keys(ywarr)
          ywx = weekofyear%ywkeys.length;
          if((ywx+1)<3){
             //行   列              内容          插入              最后一行
             for(var i = 0; i < 3;i++){
              if((i+1)<3){
               $('<tr><td>'+(i+5)+'</td><td>'+ywkeys[i+1]+' '+(ywarr[ywkeys[i+1]][0])+'</td><td></td></tr>').insertBefore($('#datasform tr:last'));}
               else {$('<tr><td>'+7+'</th><td>'+ywkeys[0]+' '+(ywarr[ywkeys[0]][0])+'</td><td></td></tr>').insertBefore($('#datasform tr:last'));}

             }
          }
          else{
             var i =0;
            $('<tr><td>'+(i+5)+'</td><td>'+ywkeys[0]+' '+(ywarr[ywkeys[0]][0])+'</td><td></td></tr>').insertBefore($('#datasform tr:last'));
            $('<tr><td>'+(i+6)+'</td><td>'+ywkeys[i+1]+' '+(ywarr[ywkeys[i+1]][0])+'</td><td></td></tr>').insertBefore($('#datasform tr:last'));
            $('<tr><td>'+(i+7)+'</td><td>'+ywkeys[i+2]+' '+(ywarr[ywkeys[i+2]][0])+'</td><td></td></tr>').insertBefore($('#datasform tr:last'));
         }
        //电话告警轮值，按每周轮值
         var telarrs = {{ telarr | safe }};
         console.log(telarrs);
         var telkeys = Object.keys(telarrs);
         x = weekofyear%telkeys.length;

        if((x+1)< telkeys.length){
           //查找表 --> tbody -->tr --> td
            $("#iphoneform tbody").find('tr').find('td.nowweek').text(telkeys[x]);
            $("#iphoneform tbody").find('tr').find('td.nextweek').text(telkeys[x+1]);

           }
        else{
           // $('<tr><th>'+telkeys[0]+'</th></tr>').insertBefore($('#iphoneform tr:last'));
            $("#iphoneform tbody").find('tr').find('td.nowweek').text(telkeys[x]);
            $("#iphoneform tbody").find('tr').find('td.nextweek').text(telkeys[x-1]);

        }
        //给表格的单行增加颜色
         //$("#iphoneform tr:odd").addClass('info');
         //$("#devopsform tr:odd").addClass('info');
         //$("#eventform tr:odd").addClass('info');
         //$("#platformform tr:odd").addClass('info');




 }
 $(function(){
function number(){
for(var i=0;i< $(".numberClass").length;i++){
$(".numberClass").get(i).innerHTML =i+1;

}
}
number();
});
</script>
{% endblock %}
