{% extends 'base.html' %}
{% block self_head_css_js %}
    <script src="/static/layer/layer.js"></script>
    <script src="/static/js/jquery.bootstrap-duallistbox.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/bootstrap-duallistbox.css">
{% endblock %}
{% block content %}

<div class="content-wrapper">


    <!-- Main content -->

    <section class="content">

<div id="dialog">
        <div class="box box-info">
            <!-- /.box-header -->
            <!-- form start -->
          <form action="{% url 'TaskStatus_index'  %}" method="post">
            {% csrf_token %}
            {{ tpl_TaskStatus_release_form.as_p }}
            <input type="hidden" id="TaskStatus_id" name="id" value="{{ obj.id }}">
            <input type="button" id="release_btn" style="width: 60pt" class="btn btn-info"   onclick="release_run();release_checkstatus();" value="上线">&nbsp;&nbsp;&nbsp;&nbsp;
         
            <a href="{% url 'TaskStatus_index' %}"><li style="width: 60pt" class="btn btn-primary" value="">返回</li></a><br>
           
          </form>
          <br>
          <br>
          <div class="box-footer with-border">
          <strong>状态栏:</strong>
		          <div class="row">
				          <div class="col-md-3">同步项目文件到目标服务器</div>
				          <div class="col-md-3">pre release 任务</div>
				          <div class="col-md-3">更改实例软连接</div>
				          <div class="col-md-3">post release 任务</div>
		          </div>
                
		          <div id="prog_out" class="progress">
		          <div id="prog_in" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
		          <span id="prog_percentage">0%</span>
		          </div>
		        </div>
		        
		        <div id="message_box"></div>
				</div>
      </div>
</div>

    </section>

  </div>
{#回传参数至父层#}
<script type="text/javascript">
        var index = parent.layer.getFrameIndex(window.name);
        var success = {{ tpl_window_status }};
        if ( success == '1' ) {
            parent.$("#handle_status").val('1');
            parent.layer.close(index);
        } else if( success == '2' ) {
            parent.$("#handle_status").val('2');
            parent.layer.close(index);
        }
</script>

<script type="text/javascript">
function release_run(){
	var obj_id=$("#TaskStatus_id").val();
	$.ajax({
		url:'/skdeploy/TaskStatus/release/run/',
		type:"POST",
		data:{id:obj_id,
			csrfmiddlewaretoken:'{{ csrf_token }}'},
		
		success:function(callback){
				var obj_json = jQuery.parseJSON(callback);									   
			   }
	});
}
</script>

<script type="text/javascript">
function release_checkstatus(){
	var obj_id=$("#TaskStatus_id").val();

	var sitv = setInterval(function(){	
		$.ajax({
			url:'/skdeploy/TaskStatus/release/status/',
			type:"POST",
			data:{id:obj_id,
				csrfmiddlewaretoken:'{{ csrf_token }}'},
			success:function(callback){
				var obj_json = jQuery.parseJSON(callback);
				message = obj_json["redis_chanel_message"]
				$("#message_box").text(message);
				$('#prog_in').width(obj_json["redis_chanel"] + '%');
				$("#prog_percentage").text(obj_json["redis_chanel"] + '%');
				if (message.indexOf("failed") > 0 ) {
					clearInterval(sitv);
			
				}
				
				if (obj_json["redis_chanel"] == "100" ) {
					clearInterval(sitv);
					$("#message_box").text("恭喜发布成功");
					$("#release_btn").attr("disabled","disabled")
					
				}
					
				console.log(message);
				
			}
		})
		
	},1000)
	
}
</script>


{% endblock %}



