

{% extends 'base.html' %}
{% block self_head_css_js %}
    <script src="/static/layer/layer.js"></script>
    <script src="/static/js/jquery.bootstrap-duallistbox.js"></script>
    <link rel="stylesheet" type="text/css" href="/static/css/bootstrap-duallistbox.css">
{% endblock %}
{% block content %}
<div class="content-wrapper">


    <!-- Main content -->

    <section class="content">

<div id="dialog">
        <div class="box box-info">
            <!-- /.box-header -->
            <!-- form start -->
          <form action="{% url 'WorkOrderCommit_add' ids %}" method="post" id="WorkOrderCommit_add_form">
            {% csrf_token %}
            {{ tpl_WorkOrderCommit_form.as_p }}
         
            {% for x in tpl_custom_form_list %}
            	{{ x.as_p }}
            {% endfor %}
            
            <input type="hidden" name="id" value="{{ obj.id }}">
            <input type="button" class="btn btn-info" style="width: 60pt"  id="WorkOrderCommit_add" value="提交">&nbsp;&nbsp;&nbsp;&nbsp;
            <a href="{% url 'WorkOrderCommit_index' %}"><li style="width: 60pt" class="btn btn-primary" value="">返回</li></a><br>
            
          
      
          </form>
          
          <div class="box-footer with-border">前置任务检查状态栏
                
		          <div id="prog_out" class="progress">
		          <div id="prog_in" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%">
		          <span id="prog_percentage">0%</span>
		          </div>
		        </div>
		        
		        <div id="message_box"></div>
		        <div id="messagecontainer"></div>
				</div>
      </div>
</div>

    </section>

  </div>
{#回传参数至父层#}
<script type="text/javascript">
        var index = parent.layer.getFrameIndex(window.name);
        var success = {{ status }};
        if ( success == '1' ) {
            parent.$("#handle_status").val('1');
            parent.layer.close(index);
        } else if( success == '2' ) {
            parent.$("#handle_status").val('2');
            parent.layer.close(index);
        }
</script>

<script type="text/javascript">
function taskcommit_checkstatus(){
	var obj_project=$("#id_project").val();
	var obj_env=$("#id_env").val();
	
	var sitv = setInterval(function(){	
		$.ajax({
			url:'/skworkorders/WorkOrderCommit/checkstatus/',
			type:"POST",
			data:{project:obj_project,
				   env:obj_env,
				   
				   csrfmiddlewaretoken:'{{ csrf_token }}'},
			success:function(callback){
				var obj_json = jQuery.parseJSON(callback);
				message = obj_json["redis_chanel_message"]
				
				$("#message_box").text(message);
				$('#prog_in').width(obj_json["redis_chanel"] + '%');
				$("#prog_percentage").text(obj_json["redis_chanel"] + '%');
				console.log(message);
				if (message.indexOf("failed") != -1 ) {
					clearInterval(sitv);
					
			
				}
				
				if (obj_json["redis_chanel"] == "100" ) {
					clearInterval(sitv);
					$("#message_box").text("Congratulations! check success, You can submit now");
					$('#submit').removeAttr("disabled");
					$("#id_commit_id").attr("disabled","disabled")
					
				}
					
				
				
			}
		})
		
	},1000)
	
}
</script>

<script type="text/javascript">
function taskcommit_check(){
	var obj_project=$("#id_project").val();
	var obj_env=$("#id_env").val();
	var obj_project_id=$("#id_project_id").val();
	var obj_commit_id=$("#id_commit_id").val();
	$.ajax({
		url:'/skworkorders/WorkOrderCommit/check/',
		type:"POST",
		data:{project:obj_project,
			   env:obj_env,
			   project_id:obj_project_id,
			   csrfmiddlewaretoken:'{{ csrf_token }}'},
		
		success:function(callback){
				var obj_json = jQuery.parseJSON(callback);									   
			   }
	});
}
</script>

<script type="text/javascript">//<![CDATA[
$(function () {
	$.ajaxSetup({
	    contentType: "application/x-www-form-urlencoded; charset=utf-8"
	});
	var DataDeal = {
	//将从form中通过$('#form').serialize()获取的值转成json
	           formToJson: function (data) {
	               data=data.replace(/&/g,"\",\"");
	               data=data.replace(/=/g,"\":\"");
	               data="{\""+data+"\"}";
	               return data;
	            },
	};

    $('#WorkOrderCommit_add').click(function () {
        if (window.s) {
            window.s.close()
        }
        /*创建socket连接*/
        var socket = new WebSocket("ws://" + window.location.host + "/skworkorders/WorkOrderCommit/pretask/");
        window.s = socket;
        socket.onopen = function () {
            console.log('WebSocket open');//成功连接上Websocket
            var form1 = document.getElementById("WorkOrderCommit_add_form");
           
            
            var formData=$("#WorkOrderCommit_add_form").serialize();
            var formData = decodeURIComponent(formData,true);//防止中文乱码
            var formData = DataDeal.formToJson(formData);//转化为json
            console.log(formData);
         
        	   window.s.send(formData);//通过websocket发送数据
            
        };
   
        
        
       
        
       
        socket.onmessage = function (e) {
            console.log('message: ' + e.data);//打印出服务端返回过来的数据
            
            var colorConfig = { "green": ["ok", "SUCCESS","执行成功"],"yellow": ["changed","WARNING" ],  "red": ["unreachable","UNREACHABLE","failed","FAILED","Errno","执行失败"] };  
           
                var text = e.data;  
                jQuery.each(colorConfig, function (color, values) {  
                    jQuery.each(values, function (i, item) { 
                  	   var re =new RegExp(item +"="+"[1-9][0-9]*","g");

                  	   
                  	   text = text.replace(re,function(result){
                  		   return '<font color="' + color + '">' + result + '</font>'
                  	   });
                  	   
                  	   var re2 = new RegExp(item,"g");
                  	   text = text.replace(re2,function(result){
                  		   return '<font color="' + color + '">' + result + '</font>'
                  	   });
                  	   
                    });  
                });  
            
         
            
            
            $('#messagecontainer').append('<p>' + text + '</p>');
            var h = document.documentElement.scrollHeight || document.body.scrollHeight;
            window.scrollTo(h,h);
        };
   
        
    });
    $('#send_message').click(function () {
        //如果未连接到websocket
        if (!window.s) {
            alert("websocket未连接.");
        } else {
            window.s.send($('#message').val());//通过websocket发送数据
        }
    });


});
//]]></script>


<script>

$("#submit").click(function(){
	$("#id_commit_id").attr("disabled",false);
});
</script>
<script>
var demo1 = $('select[name="hosts_cus"]').bootstrapDualListbox({
      nonSelectedListLabel: '可选',
      selectedListLabel: '已选',
      preserveSelectionOnMove: 'moved',
      moveOnSelect: false,
});
</script>

{% endblock %}

