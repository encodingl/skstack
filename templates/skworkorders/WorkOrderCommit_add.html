

{% extends 'base.html' %}
{% block self_head_css_js %}
<link href="/static/plugins/iCheck/flat/green.css" rel="stylesheet">
<link href="/static/plugins/iCheck/flat/red.css" rel="stylesheet">
<link href="/static/plugins/iCheck/flat/blue.css" rel="stylesheet">
<script src="/static/plugins/iCheck/icheck.js"></script>

<script src="/static/plugins/datetimepicker/bootstrap-datetimepicker.min.js"></script>
<link rel="stylesheet" type="text/css" href="/static/plugins/datetimepicker/bootstrap-datetimepicker.min.css">
    
   
{% endblock %}
{% block content %}

<div class="content-wrapper">


    <!-- Main content -->

    <section class="content">

<div class="box">
		  <div class="box-header"> </div>
        <div class="box-body  with-border" > 
	          <form action="{% url 'WorkOrderCommit_add' ids %}" method="post" id="WorkOrderCommit_add_form">
	            {% csrf_token %}
	            {{ tpl_WorkOrderCommit_form.as_p }}         
	            {% for x in tpl_custom_form_list %}
	            	{{ x.as_p }}
	            {% endfor %}
	            <input type="hidden" name="id" value="{{ obj.id }}">
	            <input type="button" class="btn btn-info" style="width: 60pt"  id="WorkOrderCommit_add" value="提交">&nbsp;&nbsp;&nbsp;&nbsp;
	            <a href="{% url 'WorkOrderCommit_index' %}"><li style="width: 60pt" class="btn btn-primary" value="">返回</li></a><br>
	          </form>
          </div>
          
          <div class="box-footer with-border" >
	          <div class="panel panel-info">
	          
			    <div class="panel-heading">
			        <h3 class="panel-title">执行结果</h3>
			    </div>
			    
			    <div class="panel-body" style="border: 1px solid ;height:350px;overflow:scroll">

			    		<div id="messagecontainer" ></div>
			    </div>
			    
			  </div>	
		      
			 </div>
				
			
      
</div>

    </section>

  </div>
  
  
<script type="text/javascript">


	$('input#id_celery_schedule_time').datetimepicker({
	    format: "yyyy-mm-dd-hh:ii:ss",
	    autoclose: true,
	    todayHighlight: true,
	    minuteStep: 1,
	    
	});


</script>
  

<script>
  $(function () {
      $("select").select2({
    	  theme: "bootstrap"
      });
  });
</script>

<script>
  $(document).ready(function () {
      $('input').iCheck({
          checkboxClass: 'icheckbox_flat-green',
          radioClass: 'iradio_flat-green',
          increaseArea: '20%' // optional
      });
  });
</script>

<script type="text/javascript">//<![CDATA[
$(function () {
	$.ajaxSetup({
	    contentType: "application/x-www-form-urlencoded; charset=utf-8"
	});
	var DataDeal = {
	//将从form中通过$('#form').serialize()获取的值转成json
	           formToJson: function (data) {
	               data=data.replace(/&/g,"\",\"");
	               data=data.replace(/=/g,"\":\"");
	               data="{\""+data+"\"}";
	               return data;
	            },
	};

    $('#WorkOrderCommit_add').click(function () {
      if (confirm("确认?")) {
    	if (window.s) {
            window.s.close()
        }
        /*创建socket连接*/
         var ishttps = 'https:' == document.location.protocol ? true: false;

        if(ishttps){

         var socket = new WebSocket("wss://" + window.location.host + "/skworkorders/WorkOrderCommit/pretask/");

        }else{

         var socket = new WebSocket("ws://" + window.location.host + "/skworkorders/WorkOrderCommit/pretask/");

        }

        window.s = socket;
        socket.onopen = function () {
            console.log('WebSocket open');//成功连接上Websocket
            var form1 = document.getElementById("WorkOrderCommit_add_form");
           
            
            var formData=$("#WorkOrderCommit_add_form").serialize().replace(/\+/g," ");
            console.log(formData);

            var formData = decodeURIComponent(formData,true);//防止中文乱码
            var formData = DataDeal.formToJson(formData);//转化为json
            console.log(formData);
         
        	   window.s.send(formData);//通过websocket发送数据
            
        };
        socket.onerror = function () {
        	console.error('Chat socket closed unexpectedly');
        };
     
       
        socket.onmessage = function (e) {
            console.log('message: ' + e.data);//打印出服务端返回过来的数据
            
            var colorConfig = { "green": ["ok", "SUCCESS","成功"],"orange": ["changed","WARNING","warning"],  "red": ["ERROR","error","unreachable","UNREACHABLE","failed","FAILED","Errno","失败"] };
           
                var text = e.data;  
                jQuery.each(colorConfig, function (color, values) {  
                    jQuery.each(values, function (i, item) { 
                  	   var re =new RegExp(item +"="+"[1-9][0-9]*","g");

                  	   
                  	   text = text.replace(re,function(result){
                  		   return '<font color="' + color + '">' + result + '</font>'
                  	   });
                  	   
                  	   var re2 = new RegExp(item,"g");
                  	   text = text.replace(re2,function(result){
                  		   return '<font color="' + color + '">' + result + '</font>'
                  	   });
                  	   
                    });  
                });  
            
         
            
            
            $('#messagecontainer').append('<p>' + text + '</p>');
            $('.panel-body').scrollTop( $('.panel-body')[0].scrollHeight );
            
            var h = document.documentElement.scrollHeight || document.body.scrollHeight;
            window.scrollTo(h,h);
//            if (text.indexOf("finished") != -1) {
//                window.s.close();//关闭websocket
//                console.log('websocket已关闭');
//            }
            
        };
   
     }else{
       	 return false };
     
   
    });
   


});
//]]></script>





<script>
$(function () {

    $("#id_value_optional").select2();
   
});
</script>



{% endblock %}

